<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jchan</title>
    <script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
    <style>
        body { background: #eef2ff; color: #800000; font-family: sans-serif; margin: 0; }
        #bannerContainer { text-align: center; background: #fff; border-bottom: 1px solid #b7c5d9; min-height: 100px; }
        #bannerImg { max-width: 100%; height: 100px; object-fit: contain; }
        .nav { background: #d6daf0; border-bottom: 1px solid #b7c5d9; padding: 8px; text-align: center; font-size: 13px; }
        .nav a { color: #34345c; text-decoration: none; padding: 0 10px; font-weight: bold; cursor: pointer; }
        header { text-align: center; padding: 10px; }
        h1 { margin: 0; font-size: 30px; color: #af0a0f; }

        .post-form { background: #d6daf0; border: 1px solid #b7c5d9; padding: 10px; width: 95%; max-width: 450px; margin: 10px auto; display: none; }
        .label { background: #98e; color: #111; font-weight: bold; padding: 2px 5px; width: 70px; text-align: center; display: inline-block; }
        textarea { width: 100%; margin-top: 5px; box-sizing: border-box; }
        
        .thread-container { border-bottom: 1px solid #b7c5d9; padding: 15px; max-width: 800px; margin: auto; }
        .post { background: #d6daf0; border: 1px solid #b7c5d9; padding: 8px; margin: 5px 0; display: block; }
        .reply-post { margin-left: 30px; border-left: 3px solid #b7c5d9; }
        .post-header { color: #117743; font-weight: bold; font-size: 11px; margin-bottom: 5px; }
        .post-id { color: #cc1105; cursor: pointer; }
        .post-img { float: left; margin-right: 10px; max-width: 130px; max-height: 130px; border: 1px solid #aaa; }
        .post-content { color: #000; font-size: 14px; white-space: pre-wrap; word-wrap: break-word; }
        
        #adminArea { display: none; background: #333; color: white; padding: 5px; text-align: center; font-size: 12px; }
    </style>
</head>
<body>

<div id="adminArea">MODO ADMIN | <a onclick="sairAdmin()" style="color:yellow;cursor:pointer">Sair</a></div>
<div id="bannerContainer"><img id="bannerImg" src="https://i.nostr.build/8N8H1nU.png"></div>
<div class="nav">[ <a onclick="ir('home')">home</a> / <a onclick="ir('b')">b</a> / <a onclick="ir('soybr')">soybr</a> / <a onclick="loginAdmin()">admin</a> ]</div>

<header><h1>Jchan</h1><div id="btitle">/home/</div></header>

<div id="regras" style="max-width:500px; margin:auto; background:#fff; border:1px solid #af0a0f; padding:15px; display:none;">
    <h3 style="text-align:center; color:#af0a0f;">REGRAS</h3>
    <div id="listaRegras" style="font-size:12px; font-weight:bold;"></div>
</div>

<div id="postForm" class="post-form">
    <div class="label">Arquivo</div> <input type="file" id="fileInput"><br>
    <textarea id="msgInput" rows="4" placeholder="Mensagem..."></textarea><br>
    <button id="btnPost" onclick="enviarPost()" style="width:100%; margin-top:5px; font-weight:bold;">POSTAR</button>
</div>

<div id="feed"></div>

<script>
    const RELAYS = ["wss://relay.damus.io", "wss://nos.lol"];
    let boardAtivo = "home";
    let isAdmin = false;
    const pool = new window.NostrTools.SimplePool();

    const REGRAS = ["1. Sem Nazismo", "2. Sem Incel de merda", "3. Sem viadagem", "4. SEM CP (BAN)", "5. Sem fetiches sexuais", "6. Críticas ao Jchan OK"];

    function ir(id) {
        boardAtivo = id;
        document.getElementById('btitle').innerText = "/" + id + "/";
        const isHome = id === 'home';
        document.getElementById('regras').style.display = isHome ? 'block' : 'none';
        document.getElementById('postForm').style.display = isHome ? 'none' : 'block';
        if(isHome) {
            document.getElementById('listaRegras').innerHTML = REGRAS.map(r => `<p>${r}</p>`).join('');
            document.getElementById('feed').innerHTML = "";
        } else carregar();
    }

    async function enviarPost() {
        const txt = document.getElementById('msgInput').value;
        const file = document.getElementById('fileInput').files[0];
        if(!txt) return alert("Escreva algo!");
        if(!file && boardAtivo !== 'home') {
             // Verificação simples: se não houver posts no feed, é uma nova thread (precisa de imagem)
             if(document.getElementById('feed').children.length === 0) return alert("Novo post exige imagem!");
        }

        const btn = document.getElementById('btnPost');
        btn.innerText = "Enviando..."; btn.disabled = true;

        let imgUrl = "";
        if(file) {
            const fd = new FormData(); fd.append("file[]", file);
            try {
                const r = await fetch("https://nostr.build/api/v2/upload/files", {method:"POST", body:fd});
                const d = await r.json(); imgUrl = d.data[0].url;
            } catch(e) { alert("Erro na imagem"); }
        }

        const nt = window.NostrTools;
        const sk = nt.generatePrivateKey();
        const ev = {
            kind:1, pubkey:nt.getPublicKey(sk), created_at:Math.floor(Date.now()/1000),
            tags:[["t", "jchan_"+boardAtivo]], content:txt
        };
        if(imgUrl) ev.tags.push(["image", imgUrl]);
        ev.id = nt.getEventHash(ev); ev.sig = nt.getSignature(ev, sk);
        await pool.publish(RELAYS, ev);
        location.reload();
    }

    async function carregar() {
        const feed = document.getElementById('feed');
        feed.innerHTML = "<small>Sintonizando...</small>";
        let evs = await pool.list(RELAYS, [{kinds:[1], "#t":["jchan_"+boardAtivo], limit:30}]);
        evs.sort((a,b) => b.created_at - a.created_at);
        feed.innerHTML = "";
        evs.forEach(p => {
            if(localStorage.getItem("ban_"+p.id)) return;
            const img = p.tags.find(t => t[0]==='image');
            const div = document.createElement('div');
            div.className = 'thread-container';
            div.innerHTML = `
                <div class="post">
                    <div class="post-header">
                        ${isAdmin ? `<button onclick="banir('${p.id}')" style="color:red">BAN</button>` : ''}
                        Anônimo <span class="post-id" onclick="citar('${p.id.substring(0,4)}')">No.${p.id.substring(0,4)}</span>
                    </div>
                    ${img ? `<img class="post-img" src="${img[1]}">` : ''}
                    <div class="post-content">${p.content}</div>
                    <div style="clear:both"></div>
                </div>`;
            feed.appendChild(div);
        });
    }

    function citar(id) { document.getElementById('msgInput').value += ">>"+id+" "; document.getElementById('msgInput').focus(); }
    function loginAdmin() { if(prompt("Senha:")==="123456") {isAdmin=true; document.getElementById('adminArea').style.display='block'; carregar();} }
    function sairAdmin() { isAdmin=false; location.reload(); }
    function banir(id) { localStorage.setItem("ban_"+id, "1"); carregar(); }

    ir('home');
</script>
</body>
</html>
