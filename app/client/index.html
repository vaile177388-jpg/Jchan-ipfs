<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jchan</title>
    <script src="https://bundle.run/nostr-tools@1.17.0"></script>
    <style>
        body { background: #eef2ff; color: #800000; font-family: arial,sans-serif; margin: 0; padding-bottom: 50px; }
        #bannerContainer { text-align: center; padding: 10px; background: #fff; border-bottom: 1px solid #b7c5d9; }
        #bannerImg { max-width: 100%; height: 100px; object-fit: contain; background: #eee; }
        .nav { background: #d6daf0; border-bottom: 1px solid #b7c5d9; padding: 10px; text-align: center; font-size: 14px; }
        .nav a { color: #34345c; text-decoration: none; padding: 0 10px; font-weight: bold; cursor: pointer; }
        header { text-align: center; padding: 10px; }
        h1 { margin: 0; font-size: 35px; color: #af0a0f; }

        /* FORMULÁRIO */
        .post-form { background: #d6daf0; border: 1px solid #b7c5d9; padding: 10px; width: 95%; max-width: 450px; margin: 10px auto; font-size: 12px; }
        .label { background: #98e; color: #111; font-weight: bold; padding: 2px 5px; width: 80px; text-align: center; }
        textarea { width: 100%; border: 1px solid #aaa; }
        
        /* THREADS */
        .thread-container { border-bottom: 2px solid #b7c5d9; padding: 15px; max-width: 900px; margin: auto; }
        .post { background: #d6daf0; border: 1px solid #b7c5d9; padding: 8px; margin: 5px 0; display: block; overflow: hidden; }
        .reply-post { margin-left: 40px; display: table; }
        .post-header { color: #117743; font-weight: bold; font-size: 12px; margin-bottom: 5px; }
        .post-id { color: #cc1105; cursor: pointer; text-decoration: underline; }
        .post-img { float: left; margin: 5px 10px 5px 0; max-width: 150px; max-height: 150px; border: 1px solid #ccc; cursor: zoom-in; }
        .post-content { color: #000; font-size: 14px; white-space: pre-wrap; word-wrap: break-word; }
        
        #adminArea { display: none; background: #333; color: #fff; padding: 10px; text-align: center; }
        .btn-ban { background: red; color: white; border: none; font-size: 10px; cursor: pointer; float: right; }
    </style>
</head>
<body>

<div id="adminArea">
    MODO ADMIN | Link Banner: <input type="text" id="newBanner"> <button onclick="addBanner()">Adicionar</button> 
    | <a onclick="sairAdmin()" style="color:yellow;cursor:pointer">Sair</a>
</div>

<div id="bannerContainer"><img id="bannerImg" src=""></div>

<div class="nav">
    [ <a onclick="ir('home')">home</a> / <a onclick="ir('b')">b</a> / <a onclick="ir('soybr')">soybr</a> / <a onclick="loginAdmin()">admin</a> ]
</div>

<header><h1>Jchan</h1><div id="btitle" style="font-weight:bold">/home/</div></header>

<div id="regras" style="max-width:600px; margin:auto; background:#fff; border:1px solid #af0a0f; padding:15px; display:none;">
    <h3 style="text-align:center;color:#af0a0f">REGRAS DO JCHAN</h3>
    <div id="regrasLista"></div>
</div>

<div id="postForm" class="post-form" style="display:none;">
    <table style="width:100%">
        <tr><td class="label">Arquivo</td><td><input type="file" id="fileInput"></td></tr>
        <tr><td class="label">Texto</td><td><textarea id="msgInput" rows="5"></textarea></td></tr>
        <tr><td></td><td><button id="btnPost" onclick="enviarPost()" style="width:100%">Postar</button></td></tr>
    </table>
</div>

<div id="feed"></div>

<script>
    const RELAYS = ["wss://relay.damus.io", "wss://nos.lol", "wss://relay.nostr.band"];
    let boardAtivo = "home";
    let threadIdFocada = null;
    let isAdmin = false;
    const pool = new NostrTools.SimplePool();

    const REGRAS = [
        "1. NÃO FIQUE FORÇANDO NAZISMO OU QUALQUER OUTRA VIADAGEM DO TIPO",
        "2. NÃO SEJA UM INCEL DE MERDA NINGUÉM LIGA SE VOCÊ É VIRGEM DEMAIS",
        "3. SEM VIADAGEM OU ELIGEBETISSE",
        "4. SEM CP OU QUALQUER OUTRA COISA DO RAMO FILIA",
        "5. SEM VIADAGEM DE FETICHES OU TEMAS EXAGERADAMENTE SEXUAL",
        "6. VOCÊ PODE CRITICAR O JCHAN ABERTAMENTE SEM LEVAR BAN"
    ];

    function rotarBanner() {
        const defaultB = ["https://i.nostr.build/8N8H1nU.png"];
        const b = JSON.parse(localStorage.getItem('jchan_banners')) || defaultB;
        document.getElementById('bannerImg').src = b[Math.floor(Math.random() * b.length)];
    }

    function ir(id, tId = null) {
        boardAtivo = id;
        threadIdFocada = tId;
        document.getElementById('btitle').innerText = tId ? "/thread/" : "/" + id + "/";
        document.getElementById('regras').style.display = (id === 'home') ? 'block' : 'none';
        document.getElementById('postForm').style.display = (id === 'home') ? 'none' : 'block';
        if(id === 'home') {
            const lista = document.getElementById('regrasLista');
            lista.innerHTML = REGRAS.map(r => `<p><b>${r}</b></p>`).join('');
            document.getElementById('feed').innerHTML = "";
        } else {
            carregar();
        }
    }

    async function subirImagem(file) {
        const formData = new FormData();
        formData.append("file[]", file);
        const res = await fetch("https://nostr.build/api/v2/upload/files", {
            method: "POST",
            body: formData
        });
        const data = await res.json();
        return data.data[0].url;
    }

    async function enviarPost() {
        const txt = document.getElementById('msgInput').value;
        const file = document.getElementById('fileInput').files[0];
        const btn = document.getElementById('btnPost');

        if(!txt) return alert("Escreva um comentário!");
        if(!threadIdFocada && !file) return alert("ERRO: Posts novos exigem imagem!");

        btn.disabled = true;
        btn.innerText = "Subindo...";

        try {
            let imgUrl = "";
            if(file) imgUrl = await subirImagem(file);

            const sk = NostrTools.generatePrivateKey();
            const pk = NostrTools.getPublicKey(sk);
            const event = {
                kind: 1, pubkey: pk, created_at: Math.floor(Date.now()/1000),
                tags: [["t", "jchan_" + boardAtivo]], content: txt
            };
            if(imgUrl) event.tags.push(["image", imgUrl]);
            if(threadIdFocada) event.tags.push(["e", threadIdFocada, "", "root"]);

            event.id = NostrTools.getEventHash(event);
            event.sig = NostrTools.getSignature(event, sk);
            await pool.publish(RELAYS, event);
            
            location.reload();
        } catch(e) {
            alert("Erro no upload. Tente novamente.");
            btn.disabled = false;
            btn.innerText = "Postar";
        }
    }

    async function carregar() {
        const feed = document.getElementById('feed');
        feed.innerHTML = "Sincronizando P2P...";
        let events = await pool.list(RELAYS, [{ kinds:[1], "#t":["jchan_"+boardAtivo] }]);
        events.sort((a,b) => a.created_at - b.created_at); // Cronológico para IDs >>1, >>2...

        feed.innerHTML = "";
        let threads = events.filter(e => !e.tags.some(t => t[0] === 'e'));
        
        threads.forEach((op, index) => {
            if(localStorage.getItem("ban_"+op.id)) return;
            const container = document.createElement('div');
            container.className = 'thread-container';
            
            const replies = events.filter(e => e.tags.some(t => t[0] === 'e' && t[1] === op.id));
            
            container.innerHTML = renderPost(op, index + 1, false);
            replies.forEach((rep, rIndex) => {
                if(localStorage.getItem("ban_"+rep.id)) return;
                container.innerHTML += renderPost(rep, `${index+1}.${rIndex+1}`, true);
            });
            feed.appendChild(container);
        });
    }

    function renderPost(p, num, isReply) {
        const img = p.tags.find(t => t[0] === 'image');
        const imgHtml = img ? `<a href="${img[1]}" target="_blank"><img class="post-img" src="${img[1]}"></a>` : '';
        return `
            <div class="post ${isReply ? 'reply-post' : ''}">
                <div class="post-header">
                    ${isAdmin ? `<button class="btn-ban" onclick="banir('${p.id}')">BAN</button>` : ''}
                    Anônimo <span class="post-id" onclick="citar('${num}')">No.${num}</span> 
                    [${new Date(p.created_at*1000).toLocaleTimeString()}]
                    ${!isReply ? `<span style="cursor:pointer;color:blue" onclick="focar('${p.id}')"> [Reply]</span>` : ''}
                </div>
                ${imgHtml}
                <div class="post-content">${p.content}</div>
            </div>
        `;
    }

    function citar(n) { document.getElementById('msgInput').value += ">>" + n + "\n"; document.getElementById('msgInput').focus(); }
    function focar(id) { threadIdFocada = id; document.getElementById('postForm').scrollIntoView(); alert("Respondendo à thread selecionada."); }
    function loginAdmin() { if(prompt("Senha:") === "123456") { isAdmin = true; document.getElementById('adminArea').style.display='block'; carregar(); } }
    function sairAdmin() { isAdmin = false; location.reload(); }
    function banir(id) { if(confirm("Banir post?")) { localStorage.setItem("ban_"+id, "1"); carregar(); } }
    function addBanner() { 
        let b = JSON.parse(localStorage.getItem('jchan_banners')) || [];
        b.push(document.getElementById('newBanner').value);
        localStorage.setItem('jchan_banners', JSON.stringify(b));
        rotarBanner();
    }

    rotarBanner();
    ir('home');
</script>
</body>
</html>
