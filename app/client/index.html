<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jchan</title>
    <script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
    <style>
        body { background: #eef2ff; color: #800000; font-family: serif; margin: 0; font-size: 13px; }
        .nav { background: #d6daf0; border-bottom: 1px solid #b7c5d9; padding: 5px; text-align: center; }
        .nav a { color: #34345c; text-decoration: none; padding: 0 10px; font-weight: bold; cursor: pointer; }
        header { text-align: center; padding: 10px; }
        h1 { margin: 0; font-size: 32px; color: #af0a0f; }
        .board-desc { color: #af0a0f; font-weight: bold; margin-bottom: 10px; font-size: 14px; }
        .post-form, .admin-login-box { background: #d6daf0; border: 1px solid #b7c5d9; padding: 10px; max-width: 480px; margin: 10px auto; text-align: center; }
        .thread-container { border-bottom: 2px solid #b7c5d9; padding: 15px; max-width: 850px; margin: auto; display: flex; flex-direction: column; }
        .post { background: #d6daf0; border: 1px solid #b7c5d9; padding: 8px; margin: 4px 0; display: table; width: fit-content; max-width: 100%; align-self: flex-start; }
        .reply { background: #d6daf0; border: 1px solid #b7c5d9; padding: 8px; margin: 4px 0 4px 40px; display: table; width: fit-content; max-width: 90%; align-self: flex-start; }
        .p-header { color: #117743; font-weight: bold; font-size: 11px; margin-bottom: 5px; text-align: left; }
        .p-name { color: #117743; }
        .p-id { color: #cc1105; cursor: pointer; }
        .p-img { float: left; margin: 5px 10px 5px 0; max-width: 155px; max-height: 155px; border: 1px solid #aaa; }
        .p-content { color: #000; font-size: 14px; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
        .quote { color: #789922; }
        #regras { max-width: 500px; margin: 20px auto; background: #fff; border: 2px solid #af0a0f; padding: 15px; }
        .admin-btn { background: #af0a0f; color: white; border: none; font-size: 9px; cursor: pointer; margin-right: 5px; padding: 2px 5px; }
    </style>
</head>
<body>

<div class="nav">
    [ <a onclick="ir('home')">home</a> / <a onclick="ir('b')">b</a> / <a onclick="ir('soybr')">soybr</a> / <a onclick="abrirAdmin()">admin</a> ]
</div>

<header>
    <h1>Jchan</h1>
    <b id="btitle">/home/</b>
    <div id="boardDesc" class="board-desc"></div>
</header>

<div id="regras" style="display:none;">
    <h3 style="text-align:center; color:#af0a0f; margin-top:0;">REGRAS DO JCHAN</h3>
    <ul style="list-style:none; padding:0; font-weight:bold; line-height:1.6;">
        <li>1. SEM NAZISMO OU VIADAGEM</li>
        <li>2. SEM INCEL DE MERDA</li>
        <li>3. SEM ELIGEBETISSE</li>
        <li>4. SEM CP (BAN ETERNO)</li>
        <li>5. SEM FETICHES EXAGERADOS</li>
        <li>6. CRÍTICAS AO JCHAN LIBERADAS</li>
    </ul>
</div>

<div id="adminLogin" class="admin-login-box" style="display:none;">
    <h3 style="margin-top:0;">Painel de Administração</h3>
    <input type="password" id="admPassField" placeholder="Digite a senha..." style="width:80%; padding:5px;"><br><br>
    <button onclick="validarAdmin()" style="width:85%; font-weight:bold; padding:5px; cursor:pointer;">ENTRAR NO MODO MODERADOR</button>
</div>

<div id="postForm" class="post-form" style="display:none;">
    <input type="text" id="name" placeholder="Nome" style="width:140px;">
    <input type="file" id="f" accept="image/*" style="width:200px;"><br>
    <textarea id="m" rows="4" style="width:98%; margin-top:5px;" placeholder="Mensagem..."></textarea><br>
    <button id="btn" onclick="postar()" style="width:100%; font-weight:bold;">ENVIAR POST</button>
</div>

<div id="feed"></div>

<script>
    const RELAYS = ["wss://nos.lol", "wss://relay.damus.io", "wss://relay.nostr.band"];
    let currentBoard = "home";
    let isAdmin = false;
    let singlePostView = null;
    const pool = new window.NostrTools.SimplePool();
    
    const ADM_HASH = "8575a7c2e8113f8c8728b12204e38e1f579893796d13264c74384a51e60f0985"; // Hash de linkpark

    const DESCRICOES = {
        "home": "",
        "b": "Unidos e Inseparáveis",
        "soybr": "Uma eterna festa"
    };

    function ir(boardId, postId = null) {
        singlePostView = postId;
        currentBoard = boardId;
        
        // Esconde o login admin se mudar de página
        document.getElementById('adminLogin').style.display = 'none';
        
        document.getElementById('btitle').innerText = postId ? "/reply/" : "/" + boardId + "/";
        document.getElementById('boardDesc').innerText = postId ? "" : (DESCRICOES[boardId] || "");
        
        document.getElementById('regras').style.display = (boardId === 'home' && !postId) ? 'block' : 'none';
        document.getElementById('postForm').style.display = (boardId === 'home' && !postId) ? 'none' : 'block';
        carregar();
    }

    function abrirAdmin() {
        document.getElementById('feed').innerHTML = "";
        document.getElementById('regras').style.display = 'none';
        document.getElementById('postForm').style.display = 'none';
        document.getElementById('btitle').innerText = "/adm/";
        document.getElementById('boardDesc').innerText = "Área Restrita";
        document.getElementById('adminLogin').style.display = 'block';
    }

    async function validarAdmin() {
        const pass = document.getElementById('admPassField').value;
        const cleanPass = pass.trim().toLowerCase();
        
        const msgUint8 = new TextEncoder().encode(cleanPass);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        if(hashHex === ADM_HASH) {
            isAdmin = true;
            alert("Modo Moderador Ativado!");
            ir('home'); // Volta para a home já com os botões de deletar
        } else {
            alert("Senha Incorreta!");
            document.getElementById('admPassField').value = "";
        }
    }

    async function postar() {
        const txt = document.getElementById('m').value;
        const nameInput = document.getElementById('name').value.trim();
        const name = nameInput || "Jorge";
        const file = document.getElementById('f').files[0];
        const btn = document.getElementById('btn');

        if(!singlePostView && !file) return alert("Novos fios exigem imagem!");
        if(!txt && !file) return alert("Nada para enviar!");

        btn.disabled = true; btn.innerText = "Subindo...";

        let imgUrl = "";
        if(file) {
            try {
                const fd = new FormData(); fd.append("fileToUpload", file); fd.append("reqtype", "fileupload");
                const res = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method: "POST", body: fd });
                imgUrl = await res.text();
            } catch(e) { alert("Erro no upload."); }
        }

        const nt = window.NostrTools;
        const sk = nt.generatePrivateKey();
        const ev = {
            kind: 1, pubkey: nt.getPublicKey(sk), created_at: Math.floor(Date.now() / 1000),
            tags: [["t", "jchan_" + currentBoard]],
            content: `[NAME]${name}[/NAME]${txt}`
        };
        if(imgUrl) ev.tags.push(["image", imgUrl]);
        if(singlePostView) ev.tags.push(["e", singlePostView]);

        ev.id = nt.getEventHash(ev);
        ev.sig = nt.getSignature(ev, sk);
        await pool.publish(RELAYS, ev);
        
        document.getElementById('m').value = ""; document.getElementById('f').value = "";
        btn.disabled = false; btn.innerText = "ENVIAR POST";
        carregar();
    }

    async function carregar() {
        if(document.getElementById('adminLogin').style.display === 'block') return;
        
        const f = document.getElementById('feed');
        f.innerHTML = "<center>Buscando posts...</center>";
        
        let evs = await pool.list(RELAYS, [{ kinds: [1, 5], "#t": ["jchan_" + currentBoard], limit: 250 }]);
        const deletedIds = new Set(evs.filter(e => e.kind === 5).flatMap(e => e.tags.filter(t => t[0] === 'e').map(t => t[1])));
        let posts = evs.filter(e => e.kind === 1 && !deletedIds.has(e.id) && !localStorage.getItem("ban_" + e.id));

        f.innerHTML = "";

        if (singlePostView) {
            const op = posts.find(p => p.id === singlePostView);
            if(op) {
                const replies = posts.filter(r => r.tags.some(t => t[0] === 'e' && t[1] === op.id));
                replies.sort((a,b) => a.created_at - b.created_at);
                renderThread(f, op, replies);
            }
        } else {
            const ops = posts.filter(p => !p.tags.some(t => t[0] === 'e'));
            ops.forEach(op => {
                const replies = posts.filter(r => r.tags.some(t => t[0] === 'e' && t[1] === op.id));
                replies.sort((a,b) => a.created_at - b.created_at);
                op.last_bump = replies.length > 0 ? Math.max(...replies.map(r => r.created_at)) : op.created_at;
                op.ordered_replies = replies;
            });
            ops.sort((a,b) => b.last_bump - a.last_bump);
            ops.forEach(op => renderThread(f, op, op.ordered_replies.slice(-5)));
        }
    }

    function renderThread(container, p, replies) {
        const formatContent = (content) => {
            return content
                .replace(/\[NAME\](.*?)\[\/NAME\]/, "")
                .replace(/>>([a-f0-9]{5})/g, '<span class="quote">>>$1</span>');
        };

        let opName = p.content.match(/\[NAME\](.*?)\[\/NAME\]/)?.[1] || "Jorge";
        const img = p.tags.find(t => t[0] === 'image');

        const div = document.createElement('div');
        div.className = 'thread-container';
        
        let opHtml = `
            <div class="post">
                <div class="p-header">
                    ${isAdmin ? `<button class="admin-btn" onclick="apagar('${p.id}')">DELETAR</button>` : ''}
                    <span class="p-name">${opName}</span> <span class="p-id" onclick="quote('${p.id.substring(0,5)}')">No.${p.id.substring(0,5)}</span>
                    [${new Date(p.created_at*1000).toLocaleTimeString()}] 
                    <a onclick="ir('${currentBoard}','${p.id}')" style="cursor:pointer">[Reply]</a>
                </div>
                ${img ? `<a href="${img[1]}" target="_blank"><img class="p-img" src="${img[1]}"></a>` : ''}
                <div class="p-content">${formatContent(p.content)}</div>
                <div style="clear:both"></div>
            </div>
        `;

        let repliesHtml = "";
        replies.forEach(r => {
            let rName = r.content.match(/\[NAME\](.*?)\[\/NAME\]/)?.[1] || "Jorge";
            const rImg = r.tags.find(t => t[0] === 'image');
            repliesHtml += `
                <div class="reply">
                    <div class="p-header">
                        ${isAdmin ? `<button class="admin-btn" onclick="apagar('${r.id}')">DELETAR</button>` : ''}
                        <span class="p-name">${rName}</span> <span class="p-id" onclick="quote('${r.id.substring(0,5)}')">No.${r.id.substring(0,5)}</span> [${new Date(r.created_at*1000).toLocaleTimeString()}]
                    </div>
                    ${rImg ? `<a href="${rImg[1]}" target="_blank"><img class="p-img" src="${rImg[1]}"></a>` : ''}
                    <div class="p-content">${formatContent(r.content)}</div>
                    <div style="clear:both"></div>
                </div>`;
        });

        div.innerHTML = opHtml + repliesHtml;
        container.appendChild(div);
    }

    async function apagar(id) {
        if(!confirm("Banir este post?")) return;
        localStorage.setItem("ban_" + id, "1");
        const nt = window.NostrTools;
        const sk = nt.generatePrivateKey();
        const ev = {
            kind: 5, pubkey: nt.getPublicKey(sk), created_at: Math.floor(Date.now()/1000),
            tags: [["e", id], ["t", "jchan_" + currentBoard]], content: "Admin Delete"
        };
        ev.id = nt.getEventHash(ev); ev.sig = nt.getSignature(ev, sk);
        await pool.publish(RELAYS, ev);
        carregar();
    }

    function quote(id) { 
        document.getElementById('m').value += ">>" + id + " "; 
        document.getElementById('m').focus(); 
    }

    ir('home');
</script>
</body>
</html>
