<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jchan</title>
    <script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
    <style>
        body { background: #eef2ff; color: #800000; font-family: arial,sans-serif; margin: 0; }
        
        /* BANNER */
        #bannerContainer { text-align: center; padding: 10px; background: #fff; border-bottom: 1px solid #b7c5d9; }
        #bannerImg { max-width: 100%; height: 100px; object-fit: contain; }

        .nav { background: #d6daf0; border-bottom: 1px solid #b7c5d9; padding: 5px; text-align: center; font-size: 13px; }
        .nav a { color: #34345c; text-decoration: none; padding: 0 7px; font-weight: bold; cursor: pointer; }
        
        header { text-align: center; padding: 10px; }
        h1 { margin: 0; font-size: 28px; color: #af0a0f; }

        /* FORMULÁRIO ESTILO CHAN */
        .post-form { background: #d6daf0; border: 1px solid #b7c5d9; padding: 10px; width: 95%; max-width: 450px; margin: 10px auto; font-size: 12px; }
        .post-form table { width: 100%; }
        .post-form td { padding: 2px; }
        .label { background: #98e; color: #111; font-weight: bold; padding: 2px 5px; width: 80px; }
        input[type="text"], textarea { width: 100%; border: 1px solid #aaa; }
        
        /* POSTS */
        #feed { padding: 10px; }
        .thread { border-bottom: 1px solid #b7c5d9; padding: 10px; margin-bottom: 20px; }
        .post { background: #d6daf0; border: 1px solid #b7c5d9; padding: 5px; display: inline-block; min-width: 400px; max-width: 90%; margin-top: 5px; }
        .post-header { color: #117743; font-weight: bold; font-size: 12px; }
        .post-id { color: #444; font-weight: normal; cursor: pointer; }
        .post-id:hover { color: #ff0000; }
        .post-img { float: left; margin: 5px 10px 5px 0; max-width: 150px; max-height: 150px; cursor: pointer; }
        .post-content { color: #000; font-size: 14px; }
        
        /* ADMIN PANEL */
        #adminArea { display: none; background: #333; color: #fff; padding: 10px; text-align: center; }
    </style>
</head>
<body>

<div id="adminArea">
    MODO ADMIN | Banner URL: <input type="text" id="newBanner" style="width:200px"> 
    <button onclick="addBanner()">Adicionar Banner</button>
</div>

<div id="bannerContainer">
    <img id="bannerImg" src="" alt="Jchan Banner">
</div>

<div class="nav">
    [ <a onclick="ir('home')">home</a> / <a onclick="ir('b')">b</a> / <a onclick="ir('soybr')">soybr</a> / <a onclick="showAdmin()">admin</a> ]
</div>

<header>
    <h1 id="jtitle">Jchan</h1>
    <div id="btitle" style="font-weight:bold">/home/</div>
</header>

<div id="regras" style="max-width:600px; margin:auto; background:#fff; border:1px solid #af0a0f; padding:15px; display:none;">
    <h3 style="text-align:center;color:#af0a0f">REGRAS DO JCHAN</h3>
    <small>1. Sem nazismo | 2. Sem incelismo | 3. Sem viadagem | 4. SEM CP (BAN) | 5. Sem fetiches exagerados | 6. Críticas permitidas.</small>
</div>

<div class="post-form" id="postForm" style="display:none;">
    <table>
        <tr><td class="label">Arquivo</td><td><input type="text" id="imgUrl" placeholder="URL da Imagem (Obrigatório p/ novo post)"></td></tr>
        <tr><td class="label">Comentário</td><td><textarea id="msgInput" rows="4"></textarea></td></tr>
        <tr><td></td><td><button onclick="enviarPost()">Postar</button></td></tr>
    </table>
</div>

<div id="feed"></div>

<script>
    const RELAYS = ["wss://relay.damus.io", "wss://nos.lol", "wss://relay.nostr.band"];
    let board = "home";
    let banners = ["https://i.imgur.com/8N8H1nU.png", "https://i.imgur.com/XqK8H9O.png"]; // Banners iniciais

    // Inicializar Banner Rotativo
    function rotarBanner() {
        const savedBanners = JSON.parse(localStorage.getItem('jchan_banners')) || banners;
        const escolhido = savedBanners[Math.floor(Math.random() * savedBanners.length)];
        document.getElementById('bannerImg').src = escolhido;
    }

    function addBanner() {
        let url = document.getElementById('newBanner').value;
        if(url) {
            let b = JSON.parse(localStorage.getItem('jchan_banners')) || banners;
            b.push(url);
            localStorage.setItem('jchan_banners', JSON.stringify(b));
            alert("Banner Adicionado!");
        }
    }

    function ir(id) {
        board = id;
        document.getElementById('btitle').innerText = "/" + id + "/";
        document.getElementById('regras').style.display = (id === 'home') ? 'block' : 'none';
        document.getElementById('postForm').style.display = (id === 'home') ? 'none' : 'block';
        if(id !== 'home') carregar();
        else document.getElementById('feed').innerHTML = "";
    }

    async function carregar() {
        const feed = document.getElementById('feed');
        feed.innerHTML = "Sincronizando...";
        const pool = new window.NostrTools.SimplePool();
        let posts = await pool.list(RELAYS, [{ kinds: [1], "#t": ["jchan_" + board], limit: 50 }]);
        posts.sort((a, b) => a.created_at - b.created_at); // Ordem cronológica para os IDs >>1, >>2
        
        feed.innerHTML = "";
        posts.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'post';
            const num = index + 1;
            const imgHtml = p.tags.find(t => t[0] === 'image') ? `<img class="post-img" src="${p.tags.find(t => t[0] === 'image')[1]}">` : '';
            
            div.innerHTML = `
                <div class="post-header">
                    Anônimo <span class="post-id" onclick="responder('${num}')">No.${num}</span> [${new Date(p.created_at*1000).toLocaleTimeString()}]
                </div>
                ${imgHtml}
                <div class="post-content">${p.content}</div>
                <div style="clear:both"></div>
            `;
            feed.appendChild(div);
        });
    }

    async function enviarPost() {
        const txt = document.getElementById('msgInput').value;
        const img = document.getElementById('imgUrl').value;
        
        if(!txt) return alert("Texto é obrigatório!");
        // Se o feed estiver vazio, é uma nova thread (exige imagem)
        if(document.getElementById('feed').innerHTML.includes("Nenhum") && !img) return alert("Imagens são obrigatórias para abrir threads!");

        const nt = window.NostrTools;
        const sk = nt.generatePrivateKey();
        const event = {
            kind: 1, pubkey: nt.getPublicKey(sk), created_at: Math.floor(Date.now()/1000),
            tags: [["t", "jchan_" + board]], content: txt
        };
        if(img) event.tags.push(["image", img]);

        event.id = nt.getEventHash(event);
        event.sig = nt.getSignature(event, sk);
        const pool = new nt.SimplePool();
        await pool.publish(RELAYS, event);
        
        document.getElementById('msgInput').value = "";
        document.getElementById('imgUrl').value = "";
        setTimeout(carregar, 1500);
    }

    function responder(id) {
        document.getElementById('msgInput').value += ">>" + id + "\n";
        document.getElementById('msgInput').focus();
    }

    function showAdmin() {
        if(prompt("Senha:") === "123456") document.getElementById('adminArea').style.display = "block";
    }

    rotarBanner();
    ir('home');
</script>
</body>
</html>
